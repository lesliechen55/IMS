layui.use(["form","layer","table","laytpl","laydate"],function(){var u=layui.form,n=parent.layer===undefined?layui.layer:top.layer,t=layui.jquery,f=layui.laytpl,r=layui.table,i=top.initFilter(window);layui.laydate.render({elem:"#startTime",type:"date",format:"yyyy-MM-dd",min:"2015-1-1",max:"2050-12-31",lang:"cn",theme:"molv",calendar:!0,done:function(i){var r=t("#endTime").val();r&&i&&i>r&&(n.alert("开始日期不能大于结束日期"),t("#startTime").val(""))}});layui.laydate.render({elem:"#endTime",type:"date",format:"yyyy-MM-dd",min:"2015-1-1",max:"2050-12-31",lang:"cn",theme:"molv",calendar:!0,done:function(i){var r=t("#startTime").val();r&&i&&i<r&&(n.alert("开始日期不能大于结束日期"),t("#endTime").val(""))}});r.render({elem:"#table",method:"post",url:"/TrackApi/UserInfo/GetPageData",height:"full-"+i.top,cellMinWidth:60,toolbar:"#toolbar",defaultToolbar:["filter","exports","print"],cols:[[{type:"numbers"},{field:"userId",title:"用户ID",templet:function(n){return n.userId=="0"?n.userId:'<a class="layui-table-link" lay-event="viewUser" lay-filter="viewUser" value="'+n.userNo+'">'+n.userId+"<\/a>"},width:180},{field:"userNo",title:"用户编号",width:90},{field:"userName",title:"用户名称"},{field:"email",title:"注册邮箱"},{field:"contactEmail",title:"联系邮箱"},{field:"scheduleFrequency",title:"调度频率",width:90,align:"center"},{field:"giftQuota",title:"赠送配额",width:90,align:"right"},{field:"remain",title:"剩余额度",width:120,align:"right",templet:function(n){return'<a class="layui-table-link" lay-event="view" lay-filter="view" value="'+n.userNo+'">'+n.remain+"<\/a>"}},{field:"todayUsed",title:"当日使用",width:90,align:"right"},{field:"contactName",title:"联系人",hide:!0},{field:"contactPhone",title:"联系电话",hide:!0},{field:"apiState",title:"接口授权",templet:function(n){return'<input type="checkbox" name="apiState" lay-skin="switch" lay-text="正常|停用" lay-filter="state" value="'+n.userNo+(n.apiState==1?'" checked':'"')+">"},width:95},{field:"createdTime",title:"注册时间",width:160},{field:"operate",title:"操作",templet:function(n){return n.userId=="0"?'<a class="layui-btn layui-btn layui-btn-xs" lay-event="reregister" lay-filter="reregister" value="'+n.userNo+'">重试<\/a>':'<a class="layui-btn layui-btn layui-btn-xs" lay-event="edit" lay-filter="edit" value="'+n.userNo+'">编辑<\/a>'},width:70}]],page:{limit:i.limit?i.limit:10,limits:[10,15,20,25],curr:i.page?i.page:1},where:{userId:i.userId,userName:i.userName,apiState:i.apiState,startTime:i.startTime,endTime:i.endTime},done:function(n,i){t("#page").val(i);t("#limit").val(this.limit);top.changeUrlParam(window)}});t("#search").on("click",function(){var i=t("form").serialize().split("&"),n={};for(var u in i)i.hasOwnProperty(u)&&(n[i[u].split("=")[0]]=decodeURIComponent(i[u].split("=")[1]).replace(/\+/g," "));return r.reload("table",{page:{curr:1},where:{userId:n.userId,userName:n.userName,apiState:n.apiState,startTime:n.startTime,endTime:n.endTime}}),!0});u.on("switch(state)",function(i){var r=i.elem.checked?1:2,f=i.elem.value,e=r==1?"您确定要启用该用户API访问授权吗？":"您确定要停止该用户API访问授权吗？<br />停止后，该用户不可请求接口";return n.open({content:e,icon:3,btn:["确定","取消"],yes:function(e){t.post("/TrackApi/UserInfo/ChangeStatus",{userNo:f,apiState:r},function(t){t.success?(i.elem.checked=i.elem.checked,n.msg("操作成功")):(n.alert("操作失败:"+t.msg,{title:"错误",icon:5}),i.elem.checked=!i.elem.checked,u.render("checkbox"));n.close(e)})},btn2:function(t){i.elem.checked=!i.elem.checked;u.render("checkbox");n.close(t)},cancel:function(){i.elem.checked=!i.elem.checked;u.render("checkbox")}}),!1});r.on("toolbar(table)",function(t){var i=r.checkStatus(t.config.id);switch(t.event){case"add":n.open({type:2,title:"添加用户",content:"/TrackApi/UserInfo/Add?iframeName="+window.name,skin:"layui-layer-lan",area:["800px","930px"],offset:"auto",shade:.3,maxmin:!0})}});r.on("tool(table)",function(i){var r=i.data,f=i.event,e=i.tr,u=JSON.parse(window.top.sessionStorage.getItem("curmenu"));switch(f){case"edit":n.open({type:2,title:"修改 "+r.userName,content:"/TrackApi/UserInfo/Edit?iframeName="+window.name+"&id="+r.userNo,skin:"layui-layer-lan",area:["800px","930px"],offset:"auto",shade:.3,maxmin:!0});break;case"reregister":t.get("/TrackApi/UserInfo/Reregister",{userNo:r.userNo},function(t){t.success?(n.msg("操作成功"),location.reload()):n.alert("操作失败:"+t.msg,{title:"错误",icon:5})});break;case"view":window.top.addMyTab("/trackapi/userinfo/view?id="+r.userNo,"API额度消耗 "+r.userName,u.topMenuName,u.leftMenuName);break;case"viewUser":window.top.addMyTab("/business/user/detail?userId="+r.userId,"用户详情 "+r.email,"systemcenter",u.leftMenuName)}})});