layui.config({base:"/module/"}).extend({xmSelect:"xm-select"}).use(["layer","jquery","form","xmSelect","laydate"],function(){function r(){var t=n("#dashboardSrc").val(),i,o,r,f,e,h;if(t!=""){if(t=decodeURIComponent(t),i=[],o=/_a=\(filters:!\(([\s\S]*?)\),linked:/,o.test(t),r=RegExp.$1,r!=""){var c=r.match(/\('\$state':\(store:appState\),[\s\S]*?\)(?:,query|,range)/g),l=/key:'?([\s\S]*?)'?,/,a=/value:'?([\s\S]*?)'?\)/,v=/params:\(query:!([\s\S]*?)\)/,y=/disabled:!([\s\S]*?),/;c.forEach(function(n){var t={},f,r;t.category="";t.type=-1;t.fieldName=l.exec(n)[1];t.isValue=!1;t.required=!1;f=y.exec(n)[1];f=="f"?(r=a.exec(n),r=r?r[1]:v.exec(n)[1],t.defaultValue=r.replace("-∞","").replace("+∞","").replace("-Infinity","").replace("Infinity","").split("+to+").join(",")):t.defaultValue="";t=u(t);i.push(t)})}f=/linked:!(?:f|t),query:\(query_string:\((?:analyze_wildcard:!t,)?query:'([\s\S]*?)'\)\)/;f.test(t)&&(e=f.exec(t)[1],e&&(h=e.split(" "),h.forEach(function(n){var t={id:0,type:3},r=n.split(":");r.length>1&&(t.fieldName=r[0],t.defaultValue=r[1],t=u(t),i.push(t))})));s(i)}}function u(t){var r,i;if(n("#hiFields").val()!="")for(r=JSON.parse(n("#hiFields").val()),i=0;i<r.length;i++)if(r[i].fieldName==t.fieldName)return r[i].defaultValue=r[i].defaultValue==null?"":r[i].defaultValue,r[i];return t}function s(i){n("#tbody").html("");i.forEach(function(t){var i=n(`<tr>
                            <td>
                                <input type="hidden" class="hiType" value="`+t.type+`">
                                <input type="hidden" class="hiCategory" value="`+t.category+`">
                                <input type="hidden" class="hiIsValue" value="`+t.isValue+`">
                                <input type="hidden" class="hiDefaultValue" value="`+t.defaultValue+`">
                                <input type="text" autocomplete="off" class="layui-input fieldName" value="`+t.fieldName+`" disabled>
                            </td>
                            <td>
                               `+eleType+`
                            </td>
                            <td>
                               <div>`+categories+`</div>
                            </td>
                            <td>
                                <div><input type="checkbox" lay-skin="switch" class="isValue" style="display:none" lay-text="是|否" `+(t.isValue?"checked":"")+` /></div>
                            </td>
                            <td>
                                <div><input type="checkbox" lay-skin="switch" class="required" lay-text="是|否" `+(t.required?"checked":"")+` /></div>
                            </td>
                            <td class="tdDefault">
                                
                            </td>
                        </tr>`);n("#tbody").append(i)});n("#tbody").find("tr").each(function(){f(n(this));e(n(this))});t.render();t.on("select(type)",function(t){var i=n(this).parents("tr");i.find(".hiType").val(t.elem.value);t.elem.value!=""&&i.find(".type").next().find("input").css("border-color","rgb(195, 195, 195)");f(i)});t.on("select(category)",function(t){var i=n(this).parents("tr");i.find(".hiCategory").val(t.elem.value);i.find(".category").val(t.elem.value);t.elem.value!=""&&(i.find(".category").next().find("input").css("border-color","rgb(195, 195, 195)"),e(i))})}function f(n){var i={fieldName:n.find(".fieldName").val(),type:n.find(".hiType").val(),category:n.find(".hiCategory").val(),defaultValue:n.find(".hiDefaultValue").val()};n.find(".tdDefault").html(h(i));n.find(".type").val(i.type);n.find(".category").val(i.category);i.type=="0"?(n.find(".category").parent().css("visibility","visible"),n.find(".isValue").parent().css("visibility","visible")):(n.find(".category").parent().css("visibility","hidden"),n.find(".isValue").parent().css("visibility","hidden"));i.type=="4"?(layui.laydate.render({elem:n.find(".startValue")[0],type:"date",format:"yyyy-MM-dd",min:"2015-1-1",max:"2050-12-31",lang:"cn",theme:"molv",calendar:!0,done:function(){}}),layui.laydate.render({elem:n.find(".endValue")[0],type:"date",format:"yyyy-MM-dd",min:"2015-1-1",max:"2050-12-31",lang:"cn",theme:"molv",calendar:!0})):i.type=="5"&&t.render()}function e(n){var t={type:n.find(".hiType").val(),category:n.find(".category").val(),isValue:n.find(".hiIsValue").val(),defaultValue:n.find(".hiDefaultValue").val()},i;t.type=="0"&&(n.find(".tdDefault").html("<div><\/div>"),i=o.render({el:n.find(".tdDefault div")[0],toolbar:{show:!0},filterable:!0,data:[],autoRow:!1}),c(t,i))}function h(n){var i="",r=n.defaultValue,t;switch(parseInt(n.type)){case 0:i="<div><\/div>";break;case 1:t=["",""];r!=""&&(t=r.split(","),t.length==1&&(t=[t[0],""]));i=`<div class="layui-input-inline" style="width:120px;">
                                    <input type="number" class="layui-input startValue" value="`+t[0]+`">
                                </div>
                                <div class="layui-input-inline" style="width:5px">
                                    <label class="layui-form-label-col">-</label>
                                </div>
                                <div class="layui-input-inline" style="width:120px;margin-right:0">
                                    <input type="number" class="layui-input endValue" value="`+t[1]+`">
                                </div>`;break;case 2:case 3:i=`<input type="text" placeholder="请输入默认值（选填）" autocomplete="off" class="layui-input defaultValue" value="`+r+`">`;break;case 4:t=["",""];r!=""&&(t=r.split(","),t.length==1&&(t=[t[0],""]));i=`<div class="layui-input-inline" style="width:120px">
                                    <input type="text" class="layui-input startValue" value="`+t[0]+`">
                                </div>
                                <div class="layui-input-inline" style="width:5px">
                                    <label class="layui-form-label-col">-</label>
                                </div>
                                <div class="layui-input-inline" style="width:120px;margin-right:0">
                                    <input type="text" class="layui-input endValue" value="`+t[1]+`">
                                </div>`;break;case 5:i=`<div class="layui-input-inline">
                                 <input type="checkbox" lay-skin="switch" class="defaultValue" lay-text="是|否" `+(r=="t"?"checked":"")+` />
                              </div>`}return i}function c(t,i){var r=[],u=t.defaultValue.split(",");n.ajax({url:"/Business/ESDashboard/GetDataByCategory?category="+t.category,method:"get",dataType:"json",success:function(t){t.data.forEach(function(t){var i={};i.name=t.name;i.value=t.isValue=="true"?t.value:t.name;n.inArray(t.value,u)>=0&&(i.selected=!0);r.push(i)});i.update({data:r})}})}var t=layui.form,n=layui.jquery,i=parent.layer===undefined?layui.layer:top.layer,o=layui.xmSelect;r();n("#dashboardSrc").blur(function(){r()});t.on("submit(form)",function(t){for(var f,e,o={permissionId:t.field.permissionId,dashboardSrc:t.field.dashboardSrc,username:t.field.username,password:t.field.password,maxDateRange:t.field.maxDateRange,fieldsConfig:[]},u=n("#tbody").find("tr"),r=0;r<u.length;r++){if(f={fieldName:n(u[r]).find(".fieldName").val(),category:n(u[r]).find(".category").val(),type:n(u[r]).find(".type").val(),isValue:n(u[r]).find(".isValue").prop("checked"),required:n(u[r]).find(".required").prop("checked")},f.type==""||f.type==null)return e=n(u[r]).find(".type").next().find("input"),e.css("border-color","#FF5722"),i.msg("请选择字段类型",{icon:5}),!1;if(f.type=="0"&&(f.category==""||f.category==null))return e=n(u[r]).find(".category").next().find("input"),e.css("border-color","#FF5722"),i.msg("请选择枚举类别",{icon:5}),!1;switch(parseInt(f.type)){case 0:f.defaultValue=n(u[r]).find(".xm-select-default").val();break;case 1:case 4:f.defaultValue=n(u[r]).find(".startValue").val()+","+n(u[r]).find(".endValue").val();break;case 5:f.defaultValue=n(u[r]).find(".defaultValue")[0].checked?"t":"f";break;default:f.defaultValue=n(u[r]).find(".defaultValue").val()}o.fieldsConfig.push(f)}return n.post("/Business/ESDashboard/Set",o,function(t){return t.success?(i.msg("操作成功",{icon:6}),n("#close").click(),!1):(i.alert("操作失败:"+t.msg,{title:"错误",icon:5}),!1)}),!1});n("#close").click(function(){var n=parent.layer.getFrameIndex(window.name);parent.layer.close(n)})});