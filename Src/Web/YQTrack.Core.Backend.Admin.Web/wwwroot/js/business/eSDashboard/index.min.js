layui.config({base:"/module/"}).extend({xmSelect:"xm-select"}).use(["layer","jquery","form","xmSelect","laydate"],function(){function f(){var i=n("#dashboardSrc").val(),r,u;i=decodeURIComponent(i).replace(/#([a-zA-Z0-9]{3,6}(?:,|\)))/g,"%23$1");r=/_g=[\s\S]*time:\(([\s\S]*?)\)\)/;u=r.exec(i);n("#time").val(u[1]);n("#dashboardSrc").val(i);t.render();o()}function e(){var n=[],i=window.location.search.substring(1),t=i.split("&");return t.forEach(function(i,r){if(i=="")t.splice(r,1);else{var u=i.split("=");u[0]!="permissionCode"&&(u[1]=decodeURIComponent(u[1]).replace(/\+/g," "),n.push({key:u[0],value:u[1]}))}}),n}function o(){var u=JSON.parse(n("#hiFields").val()),r;n("#fields").html("");u.forEach(function(t){var u=`<div class="fieldItem">
                                <div class="layui-form-mid"> &nbsp;`+t.fieldName+`
                                    <input type="hidden" class="type" value="`+t.type+`">
                                    <input type="hidden" class="fieldName" value="`+t.fieldName+`">
                                    <input type="hidden" class="category" value="`+t.category+`">
                                    <input type="hidden" class="required" value="`+t.required+`">
                                    <input type="hidden" class="isValue" value="`+t.isValue+`">
                                    <input type="hidden" class="hiDefaultValue" value="`+t.defaultValue+`">
                                </div>`,f=t.defaultValue==null?"":t.defaultValue,i=t.fieldName.replace(/\./g,"-").replace(/@/g,"_"),r;switch(parseInt(t.type)){case 0:u+='<div class="layui-input-inline" style="width:150px;"><div class="xmSelect"><\/div><\/div>';break;case 1:r=["",""];f!=""&&(r=f.split(","));u+=`<div class="layui-input-inline" style="width:120px;">
                                        <input type="number" id="`+i+`StartValue" name="`+i+`StartValue" class="layui-input startValue" value="`+r[0]+`">
                                    </div>
                                    <div class="layui-input-inline" style="width:5px">
                                        <label class="layui-form-label-col">-</label>
                                    </div>
                                    <div class="layui-input-inline" style="width:120px;">
                                        <input type="number" id="`+i+`EndValue" name="`+i+`EndValue" class="layui-input endValue" value="`+r[1]+`">
                                    </div>`;break;case 2:case 3:u+=`<div class="layui-input-inline">
                                      <input type="text" placeholder="请输入`+t.fieldName+`" autocomplete="off" class="layui-input defaultValue"  id="`+i+`" name="`+i+`" value="`+f+`">
                                   </div>`;break;case 4:r=["",""];f!=""&&(r=f.split(","));u+=`<div class="layui-input-inline" style="width:120px">
                                        <input type="text" class="layui-input startValue" id="`+i+`StartValue" name="`+i+`StartValue" value="`+r[0]+`">
                                    </div>
                                    <div class="layui-input-inline" style="width:5px">
                                        <label class="layui-form-label-col">-</label>
                                    </div>
                                    <div class="layui-input-inline" style="width:120px;">
                                        <input type="text" class="layui-input endValue" id="`+i+`EndValue" name="`+i+`EndValue" value="`+r[1]+`">
                                    </div>`;break;case 5:u+=`<div class="layui-input-inline">
                                        <input type="checkbox" lay-skin="switch" class="defaultValue" lay-text="是|否" `+(f=="t"?"checked":"")+` />
                                    </div>`}u+="<\/div>";n("#fields").append(u)});r=e();n("form").find("div.fieldItem").each(function(){s(n(this),r)});setTimeout(function(){r.forEach(function(t){t.key.indexOf("xm-")==-1&&n("form").find("#"+t.key.replace(/\./g,"-").replace(/@/g,"_")).val(t.value)});t.render();i()},500)}function s(n,t){var i={fieldName:n.find(".fieldName").val(),category:n.find(".category").val(),isValue:n.find(".isValue").val(),type:n.find(".type").val(),defaultValue:n.find(".hiDefaultValue").val()},r;i.type=="0"?(r=u.render({el:n.find("div.xmSelect")[0],toolbar:{show:!0},filterable:!0,name:"xm-"+i.fieldName.replace(/\./g,"-").replace(/@/g,"_"),data:[]}),h(i,r,t)):i.type=="4"&&(layui.laydate.render({elem:n.find(".startValue")[0],type:"date",format:"yyyy-MM-dd",min:"2015-1-1",max:"2050-12-31",lang:"cn",theme:"molv",calendar:!0,done:function(){}}),layui.laydate.render({elem:n.find(".endValue")[0],type:"date",format:"yyyy-MM-dd",min:"2015-1-1",max:"2050-12-31",lang:"cn",theme:"molv",calendar:!0}))}function h(t,i,r){var f=[],e=[],u={};r.forEach(function(n){if(n.key=="xm-"+t.fieldName)return u=n,!1});e=u.key?u.value.split(","):t.defaultValue.split(",");n.ajax({url:"/Business/ESDashboard/GetDataByCategory?category="+t.category,method:"get",dataType:"json",success:function(t){t.data.forEach(function(t){var i={};i.name=t.name;i.value=t.isValue=="true"?t.value:t.name;n.inArray(t.value,e)>=0&&(i.selected=!0);f.push(i)});i.update({data:f,autoRow:!1})}})}function i(){var i=n("#dashboardSrc").val(),c,h,l,u,t,v,o;if(i=="")return!1;n("#time").val()&&(c=/_g=[\s\S]*time:\(([\s\S]*?)\)\)/,h=c.exec(i),i=i.replace(h[0],h[0].replace(h[1],n("#time").val())));l=/_a=\(filters:!\(([\s\S]*?)\),linked:/;l.test(i);var a=RegExp.$1,y=a.match(/\('\$state':\(store:appState\),[\s\S]*?\)(?:,query|,range)/g),p=/key:'?([\s\S]*?)'?,/,w=/value:'?([\s\S]*?)'?\)/,b=/params:\(query:!([\s\S]*?)\)/,s="",f="",e=n("#fields").find("div.fieldItem");for(e.length==0&&n("#fields").next("br").remove(),u=0;u<e.length;u++){t={fieldName:n(e[u]).find(".fieldName").val(),category:n(e[u]).find(".category").val(),required:n(e[u]).find(".required").val(),isValue:n(e[u]).find(".isValue").val(),type:n(e[u]).find(".type").val()};switch(parseInt(t.type)){case 0:t.inputValue=n(e[u]).find(".xm-select-default").val();break;case 1:case 4:t.inputValue=n(e[u]).find(".startValue").val()+","+n(e[u]).find(".endValue").val();break;case 5:t.inputValue=n(e[u]).find(".defaultValue")[0].checked?"t":"f";break;default:t.inputValue=n(e[u]).find(".defaultValue").val()}if(t.inputValue.replace(",","")==""){if(t.required=="true")return r.msg('必填项:"'+t.fieldName+'"不能为空',{icon:5}),!1;continue}y.forEach(function(n){var e=p.exec(n),i=w.exec(n),u,r;if(i||(i=b.exec(n)),t.fieldName==e[1]){u="";t.fieldName=t.fieldName.indexOf("@")>-1?"'"+t.fieldName+"'":t.fieldName;switch(parseInt(t.type)){case 0:f+=n.replace(i[0],i[0].replace(i[1],t.inputValue)).replace("params:!("+i[1]+")","params:!("+t.inputValue+")");t.inputValue.split(",").forEach(function(n){u+="(match_phrase:("+t.fieldName+":"+n+")),"});f+=":(bool:(minimum_should_match:1,should:!("+u.substr(0,u.length-1)+")))),";break;case 1:r=t.inputValue.split(",");u=(r[0]==""?"-∞":r[0])+" to "+(r[1]==""?"+∞":r[1]);f+=n.replace(i[0],i[0].replace(i[1],u));f+=":("+t.fieldName+":(gte:"+(r[0]==""?"!n":r[0])+",lt:"+(r[1]==""?"!n":r[1])+"))),";break;case 4:r=t.inputValue.split(",");u=(r[0]==""?"-Infinity":r[0])+" to "+(r[1]==""?"+Infinity":r[1]);f+=n.replace(i[0],i[0].replace(i[1],u));f+=":("+t.fieldName+":(gte:"+(r[0]==""?"!n":"'"+r[0]+"'")+",lt:"+(r[1]==""?"!n":"'"+r[1]+"'")+"))),";break;case 5:f+=n.replace(i[0],i[0].replace(i[1],t.inputValue)).replace("params:!("+i[1]+")","params:!("+t.inputValue+")");f+=":(match_phrase:("+t.fieldName+":!"+t.inputValue+"))),";break;default:f+=n.replace(i[0],i[0].replace(i[1],t.inputValue));f+=":(match:("+t.fieldName+":(query:"+t.inputValue+",type:phrase)))),"}}});t.inputValue!=""&&t.type=="3"&&(s+=t.fieldName+":"+t.inputValue+" AND ")}i=i.replace(a,f.substr(0,f.length-1));v=/linked:!(?:f|t),query:\(([\s\S]*?)\),/;o=v.exec(i);o.length>1&&(s!=""?o.length>1&&(s="query_string:("+(o[1].indexOf("analyze_wildcard:!t,")>-1?"analyze_wildcard:!t,":"")+"query:'"+s.substr(0,s.length-5)+"')",i=i.replace(o[0],o[0].replace(o[1],s))):i=i.replace(o[0],o[0].replace(o[1],"match_all:()")));top.changeUrlParam(window);n("iframe").attr("src",i)}var t=layui.form,n=layui.jquery,r=parent.layer===undefined?layui.layer:top.layer,u=layui.xmSelect;f();n("#search").click(function(){i()})});