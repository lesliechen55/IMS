layui.use(["layer","jquery","form","element","table","laytpl","laydate","formSelects"],function(){var e=layui.laydate,r=layui.table,u=layui.formSelects,i=layui.form,t=parent.layer===undefined?layui.layer:top.layer,n=layui.jquery;e.render({elem:"#startTime"});e.render({elem:"#endTime"});let o=JSON.parse(n("#hRules").val());t.rules=o;let h=n("#hProductId").val(),s=0,f=0;n.ajax({url:"/pay/activity/getproducts",data:{},dataType:"json",success:function(t){var r,i,f;n("#productId").empty();t.success?(n("#productId").append(new Option("请选择","")),n.each(t.data,function(t,i){t==h?n("#productId").append(new Option(i,t,!1,!0)):n("#productId").append(new Option(i,t))})):n("#productId").append(new Option("暂无数据",""));layui.form.render("select");r=JSON.parse(n("#hSkuCodes").val());i=[];n.each(r,function(n,t){var t={name:t,value:n+1};i.push(t)});u.data("skuCodes","local",{arr:i});f=Array.from(i,{value:n}=>n);u.value("skuCodes",f)}});i.on("select(productIdfilter)",function(t){var i=t.value;n.ajax({url:"/pay/activity/getskus",data:{productId:i},dataType:"json",success:function(i){t=[];i.success&&n.each(i.data,function(n,i){var i={name:i,value:n};t.push(i)});u.data("skuCodes","local",{arr:t});s=1}})});i.on("submit(form)",function(i){var r,e;if(i.field.rules=t.rules,i.field.internalUse=n("input[name=internalUse]").val(),r=u.value("skuCodes","value"),i.field.skuCodes=s==1?Array.from(r,{value:n}=>n):Array.from(r,{name:n}=>n),i.field.term=f,f==1){if(e=n("input[name='days']").val(),/^[1-9]\d*$/.test(e)==!1)return t.alert("请输入大于0的数字",{title:"错误",icon:5}),n("input[name='days']").focus(),!1;i.field.term=e}return n.post("/pay/activity/edit",i.field,function(i){return i.success?(t.msg("操作成功",{icon:6}),top.refreshParent(),n("#close").click(),!1):(t.alert("操作失败:"+i.msg,{title:"错误",icon:5}),!1)}),!1});n("#close").click(function(){var n=parent.layer.getFrameIndex(window.name);parent.layer.close(n)});r.render({elem:"#activityRule",data:o,cols:[[{type:"checkbox"},{field:"id",title:"顺序"},{field:"c",title:"货币",templet:function(n){return n.c=="0"?"未知":n.c=="1"?"人民币":n.c=="2"?"美元":void 0}},{field:"t",title:"阈值"},{field:"d",title:"优惠"}]]});n("#addRule").click(function(){var n=t.open({type:2,title:"添加规则",content:"/pay/activity/addrule?iframeName="+window.name,skin:"layui-layer-lan",area:["400px","300px"],offset:"auto",btn:["确定","取消"],shade:.3,yes:function(n){var f=t.getChildFrame("body",n),i=f.find("#currency:checked").val(),u=0,e;switch(i){case"1":i="人民币";u=1;break;case"2":i="美元";u=2;break;default:i="未知";u=0}e={id:t.rules.length+1,c:u,tag:i,t:f.find("#threshold").val(),d:f.find("#discount").val()};t.rules.push(e);r.reload("activityRule",{data:t.rules});t.close(n)}})});n("#delRule").on("click",function(){var u=r.checkStatus("activityRule"),i,f,n,e;if(u.data.length>0){for(cbList=t.rules,i=0;i<u.data.length;i++)for(f=u.data[i].id,n=0;n<cbList.length;n++)if(e=cbList[n].id,e==f){cbList.splice(n,1);break}r.reload("activityRule",{data:t.rules})}else{t.alert("请选择一行数据",{title:"错误",icon:5});return}});i.on("switch(locked)",function(t){var i=t.elem.value;i==="true"?(t.elem.value="false",n(t.elem).removeAttr("checked")):t.elem.value="true"});i.on("radio(term)",function(t){f=t.value;t.value!="1"?(n("input[name='days']").val(""),n("input[name='days']").hide()):(n("input[name='days']").show(),n("input[name='days']").focus())});let c=n("select[name='discountType']").val();c=="1"&&(n("#businessType").get(0).selectedIndex=0,n("#businessType").attr("disabled","disabled"));i.on("select(discountTypefilter)",function(t){var r=t.value;r=="1"?(n("#businessType").get(0).selectedIndex=0,n("#businessType").attr("disabled","disabled")):(n("#businessType").removeAttr("selected"),n("#businessType").removeAttr("disabled"));i.render()})});