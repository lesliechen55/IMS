layui.use(["layer","laydate","jquery","table","form","laytpl","formSelects"],function(){var u=layui.laydate,r=layui.table,f=layui.formSelects,i=layui.form,t=parent.layer===undefined?layui.layer:top.layer,n=layui.jquery;t.rules=[];u.render({elem:"#startTime"});u.render({elem:"#endTime"});i.on("submit(form)",function(i){return i.field.rules=t.rules,i.field.internalUse=i.field.internalUse=="on",i.field.skuCodes=i.field.skuCodes?i.field.skuCodes.split(","):[],n(this).addClass("layui-btn-disabled").attr("disabled","disabled"),n.post("/pay/activity/add",i.field,function(i){return i.success?(t.msg("操作成功",{icon:6}),n("#close").click(),top.refreshParent(),!0):(t.alert("操作失败:"+i.msg,{title:"错误",icon:5}),n(".layui-btn-disabled").removeClass("layui-btn-disabled").removeAttr("disabled"),!1)},"json"),!1});i.on("radio(term)",function(t){t.value!="1"?(n("input[name='days']").val(""),n("input[name='days']").hide()):(n("input[name='days']").show(),n("input[name='days']").focus())});n("#close").click(function(){var n=parent.layer.getFrameIndex(window.name);parent.layer.close(n)});n.ajax({url:"/pay/activity/getproducts",data:{},dataType:"json",success:function(t){n("#productId").empty();t.success?(n("#productId").append(new Option("请选择","")),n.each(t.data,function(t,i){n("#productId").append(new Option(i,t))})):n("#productId").append(new Option("暂无数据",""));layui.form.render("select")}});i.on("select(productIdfilter)",function(t){var i=t.value;n.ajax({url:"/pay/activity/getskus",data:{productId:i},dataType:"json",success:function(i){t=[];i.success&&n.each(i.data,function(n,i){var i={name:i,value:n};t.push(i)});f.data("skuCodes","local",{arr:t})}})});i.on("select(discountTypefilter)",function(t){var r=t.value;r=="1"?(n("#businessType").get(0).selectedIndex=0,n("#businessType").attr("disabled","disabled")):(n("#businessType").removeAttr("selected"),n("#businessType").removeAttr("disabled"));i.render()});n("#addRule").click(function(){var n=t.open({type:2,title:"添加规则",content:"/pay/activity/addrule?iframeName="+window.name,skin:"layui-layer-lan",area:["400px","300px"],offset:"auto",btn:["确定","取消"],shade:.3,yes:function(n){var f=t.getChildFrame("body",n),i=f.find("#currency:checked").val(),u=0,e;switch(i){case"1":i="人民币";u=1;break;case"2":i="美元";u=2;break;default:i="未知";u=0}e={id:t.rules.length+1,c:u,tag:i,t:f.find("#threshold").val(),d:f.find("#discount").val()};t.rules.push(e);r.reload("activityRule",{data:t.rules});t.close(n)}})});n("#delRule").on("click",function(){var u=r.checkStatus("activityRule"),i,f,n,e;if(u.data.length>0){for(cbList=t.rules,i=0;i<u.data.length;i++)for(f=u.data[i].id,n=0;n<cbList.length;n++)if(e=cbList[n].id,e==f){cbList.splice(n,1);break}r.reload("activityRule",{data:t.rules})}});r.render({elem:"#activityRule",data:t.rules,cols:[[{type:"checkbox"},{field:"id",title:"顺序"},{field:"c",title:"货币",templet:function(n){return n.c=="0"?"未知":n.c=="1"?"人民币":n.c=="2"?"美元":void 0}},{field:"t",title:"阈值"},{field:"d",title:"优惠"}]]})});