layui.use(["form","layer","table","laytpl"],function(){var r=layui.form,n=parent.layer===undefined?layui.layer:top.layer,i=layui.jquery,e=layui.laytpl,f=layui.table,u=layui.formSelects,t=top.initFilter(window,u);f.render({elem:"#table",method:"post",url:"/Pay/Product/GetPageData",height:"full-"+t.top,cellMinWidth:60,toolbar:"#toolbar",defaultToolbar:["filter","exports","print"],cols:[[{type:"numbers"},{type:"radio"},{field:"code",title:"商品编码"},{field:"name",title:"商品名称"},{field:"categoryName",title:"商品分类"},{field:"description",title:"商品描述"},{field:"serviceType",title:"服务类型"},{field:"role",title:"适用角色"},{field:"isSubscription",title:"是否订阅"},{field:"skuCount",title:"Sku数量"},{field:"active",title:"是否启用",templet:function(n){return'<input type="checkbox" name="active" lay-skin="switch" lay-text="开启|关闭" skuCount="'+n.skuCount+'" lay-filter="active" value="'+n.productId+(n.active?'" checked':'"')+">"},width:100},{field:"createAt",title:"创建时间",width:160},{field:"updateAt",title:"更新时间",width:160}]],page:{limit:t.limit?t.limit:10,limits:[10,15,20,25],curr:t.page?t.page:1},where:{productCategory:t.productCategory,serviceType:u.value("serviceType","val"),role:u.value("role","val"),keyword:t.keyword},done:function(n,t){i("#page").val(t);i("#limit").val(this.limit);top.changeUrlParam(window)}});i("#search").on("click",function(){var n=decodeURIComponent(i("form").serialize(),!0).split("&"),t={};for(var r in n)n.hasOwnProperty(r)&&(t[n[r].split("=")[0]]=n[r].split("=")[1].replace(/\+/g," "));return f.reload("table",{page:{curr:1},where:{productCategory:t.productCategory,serviceType:u.value("serviceType","val"),role:u.value("role","val"),keyword:t.keyword}}),!0});r.on("switch(active)",function(t){var u=t.elem.checked,o=i(t.elem).attr("skuCount"),f,e;return u&&o==0?(n.alert("操作失败:没有SKU数据，不能启用",{title:"错误",icon:5}),t.elem.checked=!u,r.render("checkbox"),!1):(f=t.elem.value,e=u?"您确定要启用当前商品吗":"您确定要禁用当前商品吗",n.open({content:e,icon:3,btn:["确定","取消"],yes:function(e){i.post("/Pay/Product/ChangeStatus",{productId:f,active:u},function(i){i.success?(t.elem.checked=u,n.msg("操作成功")):(n.alert("操作失败:"+i.msg,{title:"错误",icon:5}),t.elem.checked=!u,r.render("checkbox"));n.close(e)})},btn2:function(i){t.elem.checked=!u;r.render("checkbox");n.close(i)},cancel:function(){t.elem.checked=!u;r.render("checkbox")}}),!1)});f.on("toolbar(table)",function(t){var i=f.checkStatus(t.config.id),r,u;switch(t.event){case"add":n.open({type:2,title:"添加商品",content:"/Pay/Product/Add?iframeName="+window.name,skin:"layui-layer-lan",area:["900px","620px"],offset:"auto",shade:.3,maxmin:!0});break;case"update":if(i.data.length!==1){n.msg("请先选择有且仅有一个商品");return}r=i.data[0].name;u=i.data[0].productId;n.open({type:2,title:"修改 "+r,content:"/Pay/Product/Edit?iframeName="+window.name+"&id="+u,skin:"layui-layer-lan",area:["900px","620px"],offset:"auto",shade:.3,maxmin:!0})}})});